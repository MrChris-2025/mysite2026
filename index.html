<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BedroomMovies</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --accent: #a855f7;
            --accent-hover: #9333ea;
            --bg-dark: #050505;
            --surface: #121212;
            --surface-hover: #1a1a1a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
        }

        .glass-nav { 
            background: rgba(5, 5, 5, 0.85); 
            backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .premium-card {
            background: var(--surface);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .premium-card:hover {
            transform: translateY(-4px);
            border-color: rgba(168, 85, 247, 0.4);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.7);
        }

        .gallery-poster-container {
            aspect-ratio: 2/3;
            width: 100%;
            max-height: 450px;
            margin-left: auto;
            margin-right: auto;
        }

        .watched-banner {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(168, 85, 247, 0.95);
            padding: 6px 4px; color: white; font-size: 8.5px;
            font-weight: 700; text-align: center; line-height: 1.2;
            backdrop-filter: blur(8px); border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
        }

        .info-icon-btn {
            position: absolute; bottom: 8px; left: 8px; width: 28px; height: 28px;
            background: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; z-index: 20;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .info-icon-btn:hover { background: var(--accent); transform: scale(1.1); }

        .summary-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            padding: 20px; display: flex; flex-direction: column; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 30;
            backdrop-filter: blur(8px);
        }
        .summary-overlay.active { opacity: 1; pointer-events: auto; }

        .delete-btn {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
            background: rgba(239, 68, 68, 0.9); color: white; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; z-index: 60;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: all 0.2s; opacity: 0;
        }
        
        .history-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: #dc2626; transform: scale(1.1); }

        .ep-watched { color: #22c55e !important; font-weight: bold; }

        .player-wrapper {
            background: #000;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .input-pill {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .input-pill:focus {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2);
        }

        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 14px;
            padding-right: 36px !important;
        }
        option { background-color: #1a1a1a; color: white; }

        .hero-gradient {
            background: linear-gradient(to bottom, rgba(168, 85, 247, 0.15) 0%, rgba(5, 5, 5, 0) 100%);
        }

        .btn-action {
            display: flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 12px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); font-size: 14px;
            font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-action:hover:not(:disabled) {
            background: rgba(255,255,255,0.1); border-color: var(--accent); transform: translateY(-1px);
        }
        .btn-primary { background: var(--accent); color: white; border: none; }
        .btn-primary:hover { background: var(--accent-hover); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; border: 2px solid var(--bg-dark); }
    </style>
</head>
<body class="pb-24">
    <div class="fixed top-0 left-0 w-full h-96 hero-gradient -z-10 pointer-events-none"></div>

    <header class="sticky top-0 z-50 glass-nav py-4 px-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-5">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="location.reload()">
                <div class="w-11 h-11 bg-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-500/20 group-hover:scale-110 transition-transform duration-300">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter text-white">Bedroom<span class="text-purple-500">MOVIES</span></h1>
                </div>
            </div>

            <div class="relative w-full max-w-lg">
                <input type="text" id="searchInput" placeholder="Search for titles..." class="w-full input-pill rounded-xl py-3 px-12 focus:outline-none text-sm font-medium">
                <svg class="w-5 h-5 absolute left-4 top-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div class="flex bg-white/5 p-1 rounded-xl border border-white/10">
                <button id="showMoviesBtn" class="px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider bg-purple-600 text-white shadow-lg transition-all">Movies</button>
                <button id="showTvBtn" class="px-6 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-gray-400 hover:text-white transition-all">Series</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 mt-10">
        <section id="playerSection" class="hidden mb-16 animate-in fade-in slide-in-from-top-4 duration-700">
            <div class="flex flex-col md:grid md:grid-cols-10 gap-8">
                <div class="md:col-span-6 flex flex-col gap-4">
                    <div id="videoContainer" class="player-wrapper aspect-video bg-black relative group">
                        <iframe id="mainPlayer" src="" class="w-full h-full" allowfullscreen frameborder="0"></iframe>
                    </div>
                    <div class="flex justify-between items-center px-1">
                        <div class="flex items-center gap-2">
                             <button id="prevEpBtn" class="btn-action !py-2 !px-4 text-xs">Prev</button>
                             <button id="nextEpBtn" class="btn-action btn-primary !py-2 !px-4 text-xs">Next</button>
                        </div>
                        <button id="fullscreenBtn" class="btn-action !py-2 !px-4 text-xs">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                            Fullscreen
                        </button>
                    </div>
                </div>

                <div class="md:col-span-4 flex flex-col gap-6">
                    <div class="bg-white/5 p-6 rounded-[24px] border border-white/10 flex flex-col h-full justify-between">
                        <div>
                            <h2 id="playerTitle" class="text-3xl font-black text-white tracking-tight leading-tight mb-1">Title</h2>
                            <p id="playerSub" class="text-sm font-semibold text-purple-400 mb-6"></p>
                            
                            <div class="space-y-5">
                                <div class="space-y-2">
                                    <select id="srcSelect" class="custom-select w-full bg-white/5 text-sm font-semibold border border-white/10 rounded-xl px-4 py-3 outline-none hover:border-purple-500 transition-colors"></select>
                                </div>
                                <div id="tvSelectors" class="hidden grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <select id="seasonSelect" class="custom-select w-full bg-white/5 text-sm font-semibold border border-white/10 rounded-xl px-4 py-3 outline-none hover:border-purple-500 transition-colors"></select>
                                    </div>
                                    <div class="space-y-2">
                                        <select id="episodeSelect" class="custom-select w-full bg-white/5 text-sm font-semibold border border-white/10 rounded-xl px-4 py-3 outline-none hover:border-purple-500 transition-colors"></select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="episodeInfo" class="hidden mt-8 pt-6 border-t border-white/10">
                            <h3 id="epTitleDisplay" class="text-lg font-bold text-white mb-2">Episode Name</h3>
                            <p id="epOverview" class="text-gray-400 text-xs leading-relaxed line-clamp-3 mb-6">No description available.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="historySection" class="hidden mb-16">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-1 h-6 bg-purple-500 rounded-full"></div>
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em]">Recent Activity</h3>
            </div>
            <div id="historyGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        </section>

        <section id="gallerySection">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <select id="genreSelect" class="custom-select flex-1 md:w-48 bg-white/5 text-xs font-bold border border-white/10 rounded-xl px-4 py-3 outline-none hover:border-purple-500 transition-colors uppercase tracking-wider">
                        <option value="">All Genres</option>
                    </select>
                    <select id="yearSelect" class="custom-select flex-1 md:w-36 bg-white/5 text-xs font-bold border border-white/10 rounded-xl px-4 py-3 outline-none hover:border-purple-500 transition-colors uppercase tracking-wider">
                        <option value="">All Years</option>
                    </select>
                </div>
            </div>
            
            <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 md:grid-cols-5 xl:grid-cols-6 gap-x-5 gap-y-10"></div>
            
            <div class="flex justify-center items-center gap-8 mt-20 mb-12">
                <button id="prevBtn" class="w-14 h-14 bg-white/5 rounded-2xl flex items-center justify-center text-gray-400 hover:bg-purple-600 hover:text-white disabled:opacity-10 transition-all border border-white/10 hover:border-purple-400 shadow-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex flex-col items-center">
                    <span class="text-[10px] font-black text-purple-500 uppercase tracking-[0.4em] mb-1">Navigation</span>
                    <span id="pageTxt" class="text-lg font-bold text-white tracking-widest uppercase">Page 1</span>
                </div>
                <button id="nextBtn" class="w-14 h-14 bg-white/5 rounded-2xl flex items-center justify-center text-gray-400 hover:bg-purple-600 hover:text-white transition-all border border-white/10 hover:border-purple-400 shadow-xl">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </section>
    </main>

    <script>
        const CONFIG = {
            PARSE_APP_ID: "GUIFjcRB8wEOGXbBfBl8zu0yCRXLwcOTTT4dGcOT",
            PARSE_JS_KEY: "qqX1cAGsgv3yg2n8Gda2Le1CH7OUQDB7BvQdONRf",
            TMDB_KEY: '1070730380f5fee0d87cf0382670b255',
            SAVE_BUFFER_MS: 30000 
        };

        const availableSources = [
            { id: 'videasy', name: 'VidEasy', urls: { movie: 'https://player.videasy.net/movie/{id}?color=8834ec', tv: 'https://player.videasy.net/tv/{id}/{season}/{episode}?nextEpisode=true&color=8834ec' } },
            { id: 'vidsrcsu', name: 'vidsrc.su', urls: { movie: 'https://vidsrc.su/embed/movie/{id}', tv: 'https://vidsrc.su/embed/tv/{id}/{season}/{episode}' } },
            { id: 'vidfast', name: 'vidfast', urls: { movie: 'https://www.vidfast.net/movie/{id}', tv: 'https://www.vidfast.net /tv/{id}/{season}/{episode}' } },

    { id: 'vidsrcpk', name: 'VidSrcPk', urls: { movie: 'https://vidsrc.win/movie/?id={id}', tv: 'https://vidsrc.win/tv.html?id={id}&season={s}&episode={e}' } },

    { id: 'vidnest', name: 'VidNest', urls: { movie: 'https://vidnest.fun/movie/{id}', tv: 'https://vidnest.fun/tv/{id}/{s}/{e}' } },
    { id: 'bludclart', name: 'Bludclart', urls: { movie: 'https://watch.bludclart.com/movie/{id}', tv: 'https://www.vidking.net/embed/tv/{id}/{s}/{e}' } },

            { id: 'wplayme', name: 'Wplay.me', urls: { movie: 'https://embed.wplay.me/embed/movie/{id}', tv: 'https://embed.wplay.me/embed/tv/{id}/{season}/{episode}' } },
            { id: 'rive', name: 'RiveStream', urls: { movie: 'https://rivestream.org/embed?type=movie&id={id}', tv: 'https://rivestream.org/embed?type=tv&id={id}&season={season}&episode={episode}' } },
            { id: 'vidpop', name: 'Vidpop', urls: { movie: 'https://www.vidpop.xyz/embed/?id={id}', tv: 'https://www.vidpop.xyz/embed/?id={id}&season={season}&episode={episode}' } },

    { id: 'hexa', name: 'Hexa', urls: { movie: 'https://hexa.watch/watch/movie/{id}', tv: 'https://hexa.watch/watch/tv/{id}/{s}/{e}' } },

    { id: 'spenflix', name: 'SpenFlix', urls: { movie: 'https://spencerdevs.xyz/movie/{id}', tv: 'https://spencerdevs.xyz/tv/{id}/{s}/{e}' } },

            { id: 'pstream', name: 'P-Stream', urls: { movie: 'https://iframe.pstream.org/embed/tmdb-movie-{id}', tv: 'https://iframe.pstream.org/embed/tmdb-tv-{id}/{season}/{episode}' } }
        ];

        const noSandboxSources = ['videasy', 'vidsrcsu', 'vidfast'];
        let state = { user: null, type: 'movie', page: 1, query: '', history: {}, current: null, currentEpisodes: [], genre: '', year: '' };
        let galleryData = [];
        let saveTimeout = null;

        async function init() {
            Parse.initialize(CONFIG.PARSE_APP_ID, CONFIG.PARSE_JS_KEY);
            Parse.serverURL = "https://parseapi.back4app.com";
            let user = Parse.User.current() || await Parse.User.logIn("vault_user", "vault_pass").catch(() => {
                const u = new Parse.User(); u.set("username", "vault_user"); u.set("password", "vault_pass"); return u.signUp();
            });
            state.user = user;
            await fetchHistory();
            populateYears();
            await fetchGenres();
            renderSources(); fetchGallery(); setupEvents();
        }

        function formatDate(date) {
            if (!date) return "--/--/----";
            const d = new Date(date);
            return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
        }

        function populateYears() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 1950; i--) {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = i;
                yearSelect.appendChild(opt);
            }
        }

        async function fetchGenres() {
            const res = await fetch(`https://api.themoviedb.org/3/genre/${state.type}/list?api_key=${CONFIG.TMDB_KEY}`);
            const data = await res.json();
            const genreSelect = document.getElementById('genreSelect');
            genreSelect.innerHTML = '<option value="">All Genres</option>' + 
                data.genres.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        }

        async function fetchHistory() {
            const query = new Parse.Query("WatchedItem");
            query.equalTo("user", state.user);
            query.descending("watchedDate");
            try {
                const results = await query.find();
                state.history = {};
                results.forEach(item => {
                    const tmdbId = item.get("tmdbId");
                    const s = item.get("lastWatchedSeason");
                    const e = item.get("lastWatchedEpisode");
                    if(!state.history[tmdbId]) state.history[tmdbId] = {};
                    state.history[tmdbId][`${s}-${e}`] = {
                        id: item.id, obj: item, type: item.get("mediaType"), season: s, episode: e,
                        title: item.get("title"), poster: item.get("posterPath"), watchedDate: item.get("watchedDate") || item.updatedAt
                    };
                });
                renderHistory(); renderGallery();
            } catch (e) { console.error(e); }
        }

        function triggerSaveBuffer(item, s = 0, e = 0) {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                performActualSave(item, s, e);
            }, CONFIG.SAVE_BUFFER_MS);
        }

        async function performActualSave(item, s = 0, e = 0) {
            const WatchedItem = Parse.Object.extend("WatchedItem");
            const tmdbId = item.id.toString();
            const key = `${s}-${e}`;
            let record = (state.history[tmdbId] && state.history[tmdbId][key]) ? state.history[tmdbId][key].obj : new WatchedItem();
            record.set("user", state.user); record.set("tmdbId", tmdbId); record.set("mediaType", state.type); 
            record.set("lastWatchedSeason", parseInt(s)); record.set("lastWatchedEpisode", parseInt(e)); 
            record.set("title", item.title || item.name); record.set("posterPath", item.poster_path); record.set("watchedDate", new Date());
            try {
                const saved = await record.save();
                if(!state.history[tmdbId]) state.history[tmdbId] = {};
                state.history[tmdbId][key] = { id: saved.id, obj: saved, type: state.type, season: s, episode: e, title: item.title || item.name, poster: item.poster_path, watchedDate: new Date() };
                renderHistory(); 
                renderGallery(); 
            } catch (err) { console.error(err); }
        }

        async function deleteHistoryItem(tmdbId, event) {
            event.stopPropagation();
            try {
                const query = new Parse.Query("WatchedItem");
                query.equalTo("user", state.user);
                query.equalTo("tmdbId", tmdbId);
                const results = await query.find();
                await Parse.Object.destroyAll(results);
                delete state.history[tmdbId];
                renderHistory(); 
                renderGallery(); 
                if (state.current && state.current.id.toString() === tmdbId) {
                    const s = document.getElementById('seasonSelect').value;
                    const e = document.getElementById('episodeSelect').value;
                    updateEpisodeDropdown(s, e);
                }
            } catch (err) { console.error(err); }
        }

        function renderHistory() {
            const grid = document.getElementById('historyGrid');
            const section = document.getElementById('historySection');
            const uniqueShowsLatest = [];
            for (const tmdbId in state.history) {
                const episodes = Object.values(state.history[tmdbId]);
                const latest = episodes.sort((a,b) => b.watchedDate - a.watchedDate)[0];
                uniqueShowsLatest.push({ tmdbId, ...latest });
            }
            const sortedRecent = uniqueShowsLatest.sort((a,b) => b.watchedDate - a.watchedDate).slice(0, 8);
            if (sortedRecent.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            grid.innerHTML = sortedRecent.map((data) => `
                <div class="history-card premium-card group flex items-center gap-4 p-3 rounded-2xl cursor-pointer" 
                     onclick="loadContent(${data.tmdbId}, '${data.type}', ${data.season}, ${data.episode})">
                    <div onclick="deleteHistoryItem('${data.tmdbId}', event)" class="delete-btn">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </div>
                    <div class="w-14 h-20 flex-shrink-0 overflow-hidden rounded-xl shadow-lg">
                        <img src="https://image.tmdb.org/t/p/w200${data.poster}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                    </div>
                    <div class="overflow-hidden">
                        <h4 class="text-sm font-bold truncate text-white mb-1 tracking-tight">${data.title}</h4>
                        <div class="flex flex-col gap-0.5">
                             <span class="text-[10px] text-purple-400 font-extrabold uppercase tracking-wider">${data.type === 'tv' ? `S${data.season} E${data.episode}` : 'Movie'}</span>
                             <span class="text-[9px] text-gray-500 font-semibold uppercase tracking-wider">Watched: ${formatDate(data.watchedDate)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function fetchGallery() {
            let url;
            if (state.query) {
                url = `https://api.themoviedb.org/3/search/${state.type}?api_key=${CONFIG.TMDB_KEY}&query=${encodeURIComponent(state.query)}&page=${state.page}`;
            } else {
                const yearParam = state.type === 'movie' ? 'primary_release_year' : 'first_air_date_year';
                url = `https://api.themoviedb.org/3/discover/${state.type}?api_key=${CONFIG.TMDB_KEY}&page=${state.page}&sort_by=popularity.desc&with_genres=${state.genre}&${yearParam}=${state.year}`;
            }
            const res = await fetch(url); const data = await res.json();
            galleryData = data.results; renderGallery();
            document.getElementById('pageTxt').innerText = `Page ${data.page}`;
            document.getElementById('prevBtn').disabled = data.page <= 1;
            if ((state.query || state.genre || state.year) && state.page === 1) {
                document.getElementById('gallerySection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function toggleSummary(id, event) {
            event.stopPropagation();
            const overlay = document.getElementById(`summary-${id}`);
            overlay.classList.toggle('active');
        }

        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = galleryData.map(item => {
                const historyObj = state.history[item.id.toString()] || {};
                const episodes = Object.values(historyObj);
                const watchData = episodes.sort((a,b) => b.watchedDate - a.watchedDate)[0];
                let bannerHtml = watchData ? `<div class="watched-banner">${watchData.type === 'tv' ? `S${watchData.season} E${watchData.episode}` : 'Movie'} Last Watched: ${formatDate(watchData.watchedDate)}</div>` : '';
                return `
                <div class="group cursor-pointer gallery-card-wrapper" onclick="loadContent(${item.id}, '${state.type}', ${watchData?.season || 1}, ${watchData?.episode || 1})">
                    <div class="premium-card gallery-poster-container rounded-2xl overflow-hidden mb-4 relative shadow-2xl">
                        <img src="https://image.tmdb.org/t/p/w400${item.poster_path}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                        <div id="summary-${item.id}" class="summary-overlay" onclick="event.stopPropagation()">
                            <h5 class="text-sm font-bold text-white mb-2">${item.title || item.name}</h5>
                            <p class="text-[11px] text-gray-300 leading-relaxed line-clamp-6">${item.overview || "No summary available."}</p>
                            <button onclick="toggleSummary(${item.id}, event)" class="mt-4 text-[10px] font-bold text-purple-400 uppercase tracking-widest text-left">Close Info</button>
                        </div>
                        <div onclick="toggleSummary(${item.id}, event)" class="info-icon-btn">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        ${bannerHtml}
                    </div>
                    <h4 class="text-sm font-bold truncate px-1 text-white group-hover:text-purple-400 transition-colors">${item.title || item.name}</h4>
                    <p class="text-[10px] text-gray-500 font-black px-1 mt-1 uppercase tracking-widest">${(item.release_date || item.first_air_date || '').split('-')[0] || 'N/A'}</p>
                </div>
                `;
            }).join('');
        }

        async function loadContent(id, type, s = 1, e = 1) {
            state.type = type; 
            const res = await fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${CONFIG.TMDB_KEY}`);
            state.current = await res.json();
            document.getElementById('playerSection').classList.remove('hidden');
            document.getElementById('playerTitle').innerText = state.current.title || state.current.name;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (type === 'tv') {
                document.getElementById('tvSelectors').classList.remove('hidden');
                document.getElementById('episodeInfo').classList.remove('hidden');
                document.getElementById('prevEpBtn').classList.remove('hidden');
                document.getElementById('nextEpBtn').classList.remove('hidden');
                const seasons = state.current.seasons.filter(x => x.season_number > 0);
                const sSelect = document.getElementById('seasonSelect');
                sSelect.innerHTML = seasons.map(x => `<option value="${x.season_number}">Season ${x.season_number}</option>`).join('');
                sSelect.value = s; await updateEpisodes(s, e);
            } else {
                document.getElementById('tvSelectors').classList.add('hidden');
                document.getElementById('episodeInfo').classList.add('hidden');
                document.getElementById('prevEpBtn').classList.add('hidden');
                document.getElementById('nextEpBtn').classList.add('hidden');
                document.getElementById('playerSub').innerText = "Movie Stream";
                updatePlayer(); triggerSaveBuffer(state.current);
            }
        }

        async function updateEpisodes(sNum, eNum = 1) {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${state.current.id}/season/${sNum}?api_key=${CONFIG.TMDB_KEY}`);
            const data = await res.json();
            state.currentEpisodes = data.episodes;
            updateEpisodeDropdown(sNum, eNum);
            updateEpisodeDetails(eNum);
            updatePlayer(); 
            triggerSaveBuffer(state.current, sNum, eNum);
        }

        function updateEpisodeDropdown(sNum, currentENum) {
            const eSelect = document.getElementById('episodeSelect');
            const historyForThisShow = state.history[state.current.id.toString()] || {};
            eSelect.innerHTML = state.currentEpisodes.map(ep => {
                const key = `${sNum}-${ep.episode_number}`;
                const isWatched = !!historyForThisShow[key];
                return `<option value="${ep.episode_number}" class="${isWatched ? 'ep-watched' : ''}">
                    ${isWatched ? '✓ ' : ''}Episode ${ep.episode_number}
                </option>`;
            }).join('');
            if (currentENum) eSelect.value = currentENum;
        }

        function updateEpisodeDetails(eNum) {
            const episode = state.currentEpisodes.find(ep => ep.episode_number == eNum);
            if (!episode) return;
            document.getElementById('playerSub').innerText = `Season ${episode.season_number} • Episode ${eNum}`;
            document.getElementById('epTitleDisplay').innerText = episode.name;
            document.getElementById('epOverview').innerText = episode.overview || "No description available for this episode.";
            const sNum = document.getElementById('seasonSelect').value;
            const maxEpisodes = state.currentEpisodes.length;
            const maxSeasons = state.current.seasons.filter(x => x.season_number > 0).length;
            document.getElementById('prevEpBtn').disabled = (eNum <= 1 && sNum <= 1);
            document.getElementById('nextEpBtn').disabled = (eNum >= maxEpisodes && sNum >= maxSeasons);
        }

        function updatePlayer() {
            const srcId = document.getElementById('srcSelect').value;
            const src = availableSources.find(x => x.id === srcId) || availableSources[0];
            const player = document.getElementById('mainPlayer');
            const s = document.getElementById('seasonSelect').value || 1; 
            const e = document.getElementById('episodeSelect').value || 1;
            if (noSandboxSources.includes(src.id)) { player.removeAttribute('sandbox'); } else { player.setAttribute('sandbox', 'allow-forms allow-pointer-lock allow-same-origin allow-scripts allow-top-navigation'); }
            const url = state.type === 'movie' ? src.urls.movie.replace('{id}', state.current.id) : src.urls.tv.replace('{id}', state.current.id).replace('{season}', s).replace('{episode}', e);
            player.src = url;
        }

        async function navigateEpisode(dir) {
            let s = parseInt(document.getElementById('seasonSelect').value);
            let e = parseInt(document.getElementById('episodeSelect').value);
            if (dir === 'next') {
                if (e < state.currentEpisodes.length) { e++; } else {
                    const seasons = state.current.seasons.filter(x => x.season_number > 0);
                    if (s < seasons.length) { s++; e = 1; document.getElementById('seasonSelect').value = s; await updateEpisodes(s, e); return; }
                }
            } else {
                if (e > 1) { e--; } else if (s > 1) {
                    s--; document.getElementById('seasonSelect').value = s;
                    const res = await fetch(`https://api.themoviedb.org/3/tv/${state.current.id}/season/${s}?api_key=${CONFIG.TMDB_KEY}`);
                    const data = await res.json(); e = data.episodes.length; await updateEpisodes(s, e); return;
                }
            }
            document.getElementById('episodeSelect').value = e;
            updateEpisodeDetails(e); updateEpisodeDropdown(s, e); updatePlayer(); triggerSaveBuffer(state.current, s, e);
        }

        function renderSources() { document.getElementById('srcSelect').innerHTML = availableSources.map(x => `<option value="${x.id}">${x.name}</option>`).join(''); }

        function setupEvents() {
            document.getElementById('showMoviesBtn').onclick = () => { 
                state.type = 'movie'; state.page = 1; 
                document.getElementById('showMoviesBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('showTvBtn').classList.remove('bg-purple-600', 'text-white');
                document.getElementById('showTvBtn').classList.add('text-gray-400');
                fetchGenres(); fetchGallery(); 
            };
            document.getElementById('showTvBtn').onclick = () => { 
                state.type = 'tv'; state.page = 1; 
                document.getElementById('showTvBtn').classList.add('bg-purple-600', 'text-white');
                document.getElementById('showMoviesBtn').classList.remove('bg-purple-600', 'text-white');
                document.getElementById('showMoviesBtn').classList.add('text-gray-400');
                fetchGenres(); fetchGallery(); 
            };
            document.getElementById('searchInput').oninput = (e) => { 
                state.query = e.target.value; state.page = 1; 
                if (state.query) {
                    document.getElementById('genreSelect').value = "";
                    document.getElementById('yearSelect').value = "";
                    state.genre = ""; state.year = "";
                }
                fetchGallery(); 
            };
            document.getElementById('genreSelect').onchange = (e) => {
                state.genre = e.target.value; state.page = 1;
                state.query = ""; document.getElementById('searchInput').value = "";
                fetchGallery();
            };
            document.getElementById('yearSelect').onchange = (e) => {
                state.year = e.target.value; state.page = 1;
                state.query = ""; document.getElementById('searchInput').value = "";
                fetchGallery();
            };
            document.getElementById('prevBtn').onclick = () => { if (state.page > 1) { state.page--; fetchGallery(); } };
            document.getElementById('nextBtn').onclick = () => { state.page++; fetchGallery(); };
            document.getElementById('srcSelect').onchange = updatePlayer;
            document.getElementById('seasonSelect').onchange = (e) => updateEpisodes(e.target.value);
            document.getElementById('episodeSelect').onchange = (e) => {
                const s = document.getElementById('seasonSelect').value;
                const eVal = e.target.value;
                updateEpisodeDetails(eVal); updateEpisodeDropdown(s, eVal); updatePlayer(); triggerSaveBuffer(state.current, s, eVal);
            };
            document.getElementById('prevEpBtn').onclick = () => navigateEpisode('prev');
            document.getElementById('nextEpBtn').onclick = () => navigateEpisode('next');
            document.getElementById('fullscreenBtn').onclick = () => {
                const iframe = document.getElementById('mainPlayer');
                if (iframe.requestFullscreen) iframe.requestFullscreen();
                else if (iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
                else if (iframe.msRequestFullscreen) iframe.msRequestFullscreen();
            };
        }
        init();
    </script>
</body>
</html>

